
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>SQL for Feature Extraction (Part 2) &#8212; OpenMLDB  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Data Import" href="data_import.html" />
    <link rel="prev" title="SQL for Feature Extraction (Part 1)" href="tutorial_sql_1.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/openmldb_logo.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../about/index.html">
   About
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/intro.html">
     Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/milestones.html">
     Milestones
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/release_notes.html">
     Release Notes
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../quickstart/index.html">
   Quickstart
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../quickstart/openmldb_quickstart.html">
     OpenMLDB Quickstart
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../quickstart/java_sdk.html">
     Java SDK Quickstart
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../quickstart/python_sdk.html">
     Python SDK Quickstart
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../quickstart/rest_api.html">
     REST APIs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Tutorials
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="standalone_vs_cluster.html">
     Cluster vs. Standalone Versions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="modes.html">
     The Workflow of Cluster Version and Execution Mode
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tutorial_sql_1.html">
     SQL for Feature Extraction (Part 1)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     SQL for Feature Extraction (Part 2)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="data_import.html">
     Data Import
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="openmldbspark_distribution.html">
     OpenMLDB Spark Distribution
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../use_case/index.html">
   Use Cases
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../use_case/lightgbm_demo.html">
     OpenMLDB + LightGBM: Taxi Trip Duration Prediction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../use_case/pulsar_connector_demo.html">
     Importing Real-Time Data Streams from Pulsar
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../use_case/kafka_connector_demo.html">
     Importing Real-Time Data Streams from Kafka
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../use_case/dolphinscheduler_task_demo.html">
     Building End-to-End MLOps Workflows (OpenMLDB + DolphinScheduler)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../use_case/JD_recommendation_en.html">
     OpenMLDB + OneFlow: Prediction of Purchase Intention for High Potential Customers
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../deploy/index.html">
   Deployment
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../deploy/compile.html">
     Build
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../deploy/install_deploy.html">
     Install and Deploy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../deploy/conf.html">
     Configuration File
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../maintain/index.html">
   Maintenance
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/upgrade.html">
     Upgrade
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/backup.html">
     Backup and Restore
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/monitoring.html">
     Monitoring
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/cli.html">
     Operations in CLI
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/faq.html">
     Operation and Maintenance FAQ
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/scale.html">
     Scale-Out and Scale-In
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/diagnose.html">
     Diagnostic Tool
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../developer/index.html">
   Developers
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../developer/built_in_function_develop_guide.html">
     Built-In Function Development
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../reference/index.html">
   References
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../reference/arch/index.html">
     Architecture
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../reference/arch/online_arch.html">
       Online Module Architecture
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../reference/sql/index.html">
     SQL
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
    <label for="toctree-checkbox-10">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/language_structure/index.html">
       Language Structure
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
      <label for="toctree-checkbox-11">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/keywords.html">
         Keywords
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/object_names_identifiers.html">
         SQL Object Name
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/literals_value.html">
         Literal Value
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/case_sensitive.html">
         Case Sensitive
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/comment.html">
         Notes
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/data_types/index.html">
       Data Type
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
      <label for="toctree-checkbox-12">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/data_types/numeric_types.html">
         Numeric Type
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/data_types/string_types.html">
         String Type
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/data_types/date_and_time_types.html">
         Date and Time Type
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/functions_and_operators/index.html">
       Expressions, Functions, and Operations
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
      <label for="toctree-checkbox-13">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/functions_and_operators/operators.html">
         Operator
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/functions_and_operators/Files/udfs_8h.html">
         Built-in Functions
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/dql/index.html">
       Data Query Statement （DQL）
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
      <label for="toctree-checkbox-14">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/SELECT_STATEMENT.html">
         SELECT Overview
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/JOIN_CLAUSE.html">
         JOIN Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/WHERE_CLAUSE.html">
         WHERE Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/GROUP_BY_CLAUSE.html">
         GROUP BY Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/HAVING_CLAUSE.html">
         Having Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/WINDOW_CLAUSE.html">
         WINDOW Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/LIMIT_CLAUSE.html">
         Limit Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/NO_TABLE_SELECT_CLAUSE.html">
         No-table SELECT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/SELECT_INTO_STATEMENT.html">
         SELECT INTO
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/dml/index.html">
       Data Manipulation Statement（DML）
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
      <label for="toctree-checkbox-15">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dml/INSERT_STATEMENT.html">
         INSERT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dml/LOAD_DATA_STATEMENT.html">
         LOAD DATA INFILE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dml/DELETE_STATEMENT.html">
         DELETE
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/ddl/index.html">
       Data Definition Statement (DDL)
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
      <label for="toctree-checkbox-16">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/CREATE_DATABASE_STATEMENT.html">
         CREATE DATABASE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/SHOW_DATABASES_STATEMENT.html">
         SHOW DATABASES
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/USE_DATABASE_STATEMENT.html">
         USE DATABASE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/DROP_DATABASE_STATEMENT.html">
         DROP DATABASE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/DESC_STATEMENT.html">
         DESC
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/CREATE_TABLE_STATEMENT.html">
         CREATE TABLE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/DROP_TABLE_STATEMENT.html">
         DROP TABLE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/SHOW_TABLES_STATEMENT.html">
         SHOW TABLES
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/SHOW_VARIABLES_STATEMENT.html">
         SHOW VARIABLES
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/SET_STATEMENT.html">
         SET STATEMENT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/CREATE_INDEX_STATEMENT.html">
         CREATE INDEX
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/DROP_INDEX_STATEMENT.html">
         DROP INDEX
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/deployment_manage/index.html">
       DEPLOYMENT Management
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
      <label for="toctree-checkbox-17">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/DEPLOY_STATEMENT.html">
         DEPLOY
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/DROP_DEPLOYMENT_STATEMENT.html">
         Delete DEPLOYMENT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/SHOW_DEPLOYMENTS.html">
         View DEPLOYMENTS List
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/SHOW_DEPLOYMENT.html">
         View DEPLOYMENT Details
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/ONLINE_SERVING_REQUIREMENTS.html">
         SQL On-Line Specifications and Requirements
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/task_manage/index.html">
       Task Management
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
      <label for="toctree-checkbox-18">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/task_manage/SHOW_JOBS.html">
         SHOW JOBS
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/task_manage/SHOW_JOB.html">
         SHOW JOB
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/task_manage/STOP_JOB.html">
         STOP JOB
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/task_manage/SUBMIT_JOB.html">
         SUBMIT JOB
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../reference/ip_tips.html">
     IP Configuration
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../reference/client_config/index.html">
     Client Configuration
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
    <label for="toctree-checkbox-19">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../reference/client_config/client_spark_config.html">
       Spark Client Configuration
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav>
</br>
Current Version: main</br>
Versions：
<ul>
  <li><a href="tutorial_sql_2.html">main</a></li>
  <li><a href="../../v0.5/index.html">v0.5</a></li>
  <li><a href="../../v0.4/index.html">v0.4</a></li>
  <li><a href="../../v0.6/index.html">v0.6</a></li>
</ul>
</br>
</div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/tutorial/tutorial_sql_2.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preliminary-knowledge">
   1. Preliminary Knowledge
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sub-table-single-line-feature">
   2. Sub Table Single Line Feature
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#last-join">
   2.1 LAST JOIN
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-row-aggregation-feature-of-sub-table">
   3. Multi-Row Aggregation Feature of Sub Table
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-1-define-the-sub-table-splicing-window">
   3.1 Step 1: Define the Sub Table Splicing Window
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-2-build-multi-row-aggregation-feature-of-sub-table">
   3.2 Step 2: Build Multi-Row Aggregation Feature of Sub Table
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-group-construction">
   4. Feature Group Construction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extended-reading">
   5. Extended Reading
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>SQL for Feature Extraction (Part 2)</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preliminary-knowledge">
   1. Preliminary Knowledge
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sub-table-single-line-feature">
   2. Sub Table Single Line Feature
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#last-join">
   2.1 LAST JOIN
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multi-row-aggregation-feature-of-sub-table">
   3. Multi-Row Aggregation Feature of Sub Table
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-1-define-the-sub-table-splicing-window">
   3.1 Step 1: Define the Sub Table Splicing Window
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#step-2-build-multi-row-aggregation-feature-of-sub-table">
   3.2 Step 2: Build Multi-Row Aggregation Feature of Sub Table
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#feature-group-construction">
   4. Feature Group Construction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#extended-reading">
   5. Extended Reading
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="sql-for-feature-extraction-part-2">
<h1>SQL for Feature Extraction (Part 2)<a class="headerlink" href="#sql-for-feature-extraction-part-2" title="Permalink to this headline">#</a></h1>
<section id="preliminary-knowledge">
<h2>1. Preliminary Knowledge<a class="headerlink" href="#preliminary-knowledge" title="Permalink to this headline">#</a></h2>
<p>In the previous series of articles <a class="reference internal" href="tutorial_sql_1.html"><span class="doc std std-doc">Hands-On Tutorial for Feature Engineering Based on OpenMLDB (Part 1)</span></a>）, we introduce the basic concepts and practical tools of Feature Engineering, as well as the basic feature script development based on single table. In this article, we will introduce in detail the more complex and powerful feature script development of the multi-table based on the main table and sub table. At the same time, we still rely on the SQL syntax provided by OpenMLDB for Feature Engineering script examples. For more information about OpenMLDB, please visit <a class="reference external" href="https://github.com/4paradigm/OpenMLDB">GitHub repo of OpenMLDB</a>, and the <a class="reference external" href="http://docs-cn.openmldb.ai/">document website</a>.</p>
<p>If you want to run the SQL illustrated in this tutorial, please follow the following two steps to prepare:</p>
<ul class="simple">
<li><p>It is recommended to use the OpenMLDB docker image to run this tutorial under <strong>Stand-alone Version</strong>. Refer to <a class="reference external" href="http://docs-cn.openmldb.ai/2620852">OpenMLDB Quick Start</a> for the operation mode. If using the clustered version, please use the offline mode（<code class="docutils literal notranslate"><span class="pre">SET</span> <span class="pre">&#64;&#64;execute_mode='offline'</span></code> ）. The common online mode of the cluster version only supports the simple data preview function, so most of the SQL in the tutorial cannot be run.</p></li>
<li><p>All data related to this tutorial and the import operation script can be downloaded <a class="reference external" href="https://openmldb.ai/download/tutorial_sql/tutoral_sql_data.zip">here</a>.</p></li>
</ul>
<p>In this article, we will use the main table and sub table to illustrate. We still use the sample data of anti-fraud transactions in the previous article, including a main table user transaction table (Table 1, t1) and a sub table merchant flow table (Table 2, t2). In order to avoid the consistency of multiple data tables in the database design, it is necessary to store multiple data tables in the database design according to the general design principle. In Feature Engineering, in order to obtain enough effective information, data needs to be extracted from multiple tables thus, Feature Engineering needs to be carried out based on multiple tables.</p>
<p><strong>Table 1: Main Table, User Transaction Table t1</strong></p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>id</p></td>
<td><p>BIGINT</p></td>
<td><p>Sample ID, each sample has an unique ID</p></td>
</tr>
<tr class="row-odd"><td><p>uid</p></td>
<td><p>STRING</p></td>
<td><p>User ID</p></td>
</tr>
<tr class="row-even"><td><p>mid</p></td>
<td><p>STRING</p></td>
<td><p>Merchant ID</p></td>
</tr>
<tr class="row-odd"><td><p>cardno</p></td>
<td><p>STRING</p></td>
<td><p>Card Number</p></td>
</tr>
<tr class="row-even"><td><p>trans_time</p></td>
<td><p>TIMESTAMP</p></td>
<td><p>Transaction Time</p></td>
</tr>
<tr class="row-odd"><td><p>trans_amt</p></td>
<td><p>DOUBLE</p></td>
<td><p>Transaction Amount</p></td>
</tr>
<tr class="row-even"><td><p>trans_type</p></td>
<td><p>STRING</p></td>
<td><p>Transaction Type</p></td>
</tr>
<tr class="row-odd"><td><p>province</p></td>
<td><p>STRING</p></td>
<td><p>Province</p></td>
</tr>
<tr class="row-even"><td><p>city</p></td>
<td><p>STRING</p></td>
<td><p>City</p></td>
</tr>
<tr class="row-odd"><td><p>label</p></td>
<td><p>BOOL</p></td>
<td><p>Sample label, true|false</p></td>
</tr>
</tbody>
</table>
<p><strong>Sub Table: Table 2, Merchant Flow Table t2</strong></p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>mid</p></td>
<td><p>STRING</p></td>
<td><p>Merchant ID</p></td>
</tr>
<tr class="row-odd"><td><p>card</p></td>
<td><p>STRING</p></td>
<td><p>Card Number</p></td>
</tr>
<tr class="row-even"><td><p>purchase_time</p></td>
<td><p>TIMESTAMP</p></td>
<td><p>Purchase Time</p></td>
</tr>
<tr class="row-odd"><td><p>purchase_amt</p></td>
<td><p>DOUBLE</p></td>
<td><p>Purchase Amount</p></td>
</tr>
<tr class="row-even"><td><p>purchase_type</p></td>
<td><p>STRING</p></td>
<td><p>Purchase Type: Cash, Credit Card</p></td>
</tr>
</tbody>
</table>
<p>In the traditional relational database, in order to obtain the information of multiple tables, the most common way is to use join for splicing. However, for the requirements of Feature Engineering, the database join can not meet the requirements very efficiently. The main reason is that our main table sample table has a label column for model training, and each value can only correspond to one row of data records. Therefore, in practice, we hope that after join, the number of rows in the result table should be consistent with that in the main table.</p>
</section>
<section id="sub-table-single-line-feature">
<h2>2. Sub Table Single Line Feature<a class="headerlink" href="#sub-table-single-line-feature" title="Permalink to this headline">#</a></h2>
</section>
<section id="last-join">
<h2>2.1 LAST JOIN<a class="headerlink" href="#last-join" title="Permalink to this headline">#</a></h2>
<p>OpenMLDB currently supports<code class="docutils literal notranslate"><span class="pre">LAST</span> <span class="pre">JOIN</span></code>to perform database like join operations. LAST JOIN can be regarded as a special LEFT JOIN. On the premise of meeting the JOIN conditions, each row of the left table will spell the last row that meets the conditions. LAST JOIN is divided into disordered splicing and ordered splicing. Let’s take a simpler table as an example and assume that the schemas of tables s1 and s2 are</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">col1</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std_ts</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Then, we can do the following join operation:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- des c: In view of LAST JOIN splicing based on ORDER BY</span>
<span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">s1</span><span class="w"> </span><span class="k">LAST</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">s2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">s2</span><span class="p">.</span><span class="n">std_ts</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">s1</span><span class="p">.</span><span class="n">col1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">s2</span><span class="p">.</span><span class="n">col1</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>As shown below, when <code class="docutils literal notranslate"><span class="pre">LAST</span> <span class="pre">JOIN</span></code> configure in <code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span></code>，right click <code class="docutils literal notranslate"><span class="pre">std_ts</span></code> sort and splice the last hit data row. Take the second behavior of the left table as an example. There are 2 qualified right tables. Press <code class="docutils literal notranslate"><span class="pre">std_ts</span></code> after sorting and select the last item <code class="docutils literal notranslate"><span class="pre">3,</span> <span class="pre">b,</span> <span class="pre">2020-05-20</span> <span class="pre">10:11:13</span></code> .</p>
<p><img alt="img" src="../_images/lastjoin_1.jpg" /></p>
<p><img alt="img" src="../_images/lastjoin_2.jpg" /></p>
</section>
<section id="multi-row-aggregation-feature-of-sub-table">
<h2>3. Multi-Row Aggregation Feature of Sub Table<a class="headerlink" href="#multi-row-aggregation-feature-of-sub-table" title="Permalink to this headline">#</a></h2>
<p>For the sub table splicing scenario, OpenMLDB extends the standard window syntax and adds <a class="reference external" href="http://docs-cn.openmldb.ai/2620896">WINDOW UNION</a> characteristic. It supports splicing multiple pieces of data from the sub table to form a sub table window. Based on the sub table splicing window, it is convenient to construct the multi-row aggregation feature of the sub table. Similarly, two steps need to be completed to construct the multi-row aggregation feature of the sub table:</p>
<ul class="simple">
<li><p>Step 1: Define the sub table splicing window.</p></li>
<li><p>Step 2: Construct the multi-row aggregation feature of the sub table on the sub table splicing window.</p></li>
</ul>
</section>
<section id="step-1-define-the-sub-table-splicing-window">
<h2>3.1 Step 1: Define the Sub Table Splicing Window<a class="headerlink" href="#step-1-define-the-sub-table-splicing-window" title="Permalink to this headline">#</a></h2>
<p>Each sample row of the main table can splice multiple rows of data according to a column from the sub table, and it is allowed to define the time interval or number interval of spliced data. We use the special window syntax WINDOW UNION to define the sub table splicing condition and interval range. For the convenience of understanding, we call this kind of window as sub table splicing window.</p>
<p>The syntax of sub table splicing window is defined as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>window window_name as (UNION other_table PARTITION BY key_col ORDER BY order_col ROWS_RANGE｜ROWS BETWEEN StartFrameBound AND EndFrameBound)
</pre></div>
</div>
<p>Among them, the most basic and indispensable grammatical elements include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">UNION</span> <span class="pre">other_table</span></code>： <code class="docutils literal notranslate"><span class="pre">other_table</span></code> refers to the secondary table for WINDOW UNIOB. The primary and secondary tables need to keep the schema consistent. In most cases, the schema of the primary table and the secondary table are different. Therefore, we can ensure that the schema of the primary and secondary tables involved in window calculation is consistent by column filtering and default column configuration for the primary and secondary tables. Column filtering can also remove useless columns and only do WINDOW UNION and aggregation on key columns.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PARTITION</span> <span class="pre">BY</span> <span class="pre">key_col</span></code>: Indicates by column <code class="docutils literal notranslate"><span class="pre">key_col</span></code> splice matching data from the secondary table.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">order_col</span></code>: Indicates that the sub table splicing data set is in accordance with<code class="docutils literal notranslate"><span class="pre">order_col</span></code>sorting columns</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROWS_RANGE</span> <span class="pre">BETWEEN</span> <span class="pre">StartFrameBound</span> <span class="pre">AND</span> <span class="pre">EndFrameBound</span></code>: Represents the time interval of the sub table splicing window</p></li>
<li><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">StartFrameBound</span></code>Represents the upper bound of the window.</p></li>
<li><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span></code>: No upper bound.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">time_expression</span> <span class="pre">PRECEDING</span></code>: If it is a time interval, you can define a time offset. For example, <code class="docutils literal notranslate"><span class="pre">30d</span> <span class="pre">preceding</span></code> means that the upper bound of the window is the time of the current line - 30 days.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">EndFrameBound</span></code>Represents the lower bound of the time window.</p></li>
<li><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code>： Current row</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">time_expression</span> <span class="pre">PRECEDING</span></code>: If it is a time interval, you can define a time offset, such as <code class="docutils literal notranslate"><span class="pre">1d</span> <span class="pre">PRECEDING</span></code>. This indicates that the lower bound of the window is the time of the current line - 1 day.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">ROWS</span> <span class="pre">BETWEEN</span> <span class="pre">StartFrameBound</span> <span class="pre">AND</span> <span class="pre">EndFrameBound</span></code>: Represents the time interval of the sub table splicing window.</p></li>
<li><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">StartFrameBound</span></code>Represents the upper bound of the window.</p></li>
<li><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span></code>: No upper bound.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">PRECEDING</span></code>: If it is a number interval, you can define the number of time items. For example, <code class="docutils literal notranslate"><span class="pre">100</span> <span class="pre">PRECEDING</span></code> indicates the first 100 lines of the current line whose upper bound is.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">EndFrameBound</span></code>Represents the lower bound of the time window.</p></li>
<li><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code>： Current row</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">number</span> <span class="pre">PRECEDING</span></code>: If it is a number window, you can define the number of time bars. For example,<code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">PRECEDING</span></code> indicates the first line of the current line whose upper bound is</p></li>
</ul>
</li>
</ul>
</li>
<li><p>When configuring the window interval boundary, please note:</p></li>
<li><ul>
<li><p>At present, OpenMLDB cannot support the time after the current row as the upper and lower bounds. For example, <code class="docutils literal notranslate"><span class="pre">1d</span> <span class="pre">FOLLOWING</span></code>. In other words, we can only deal with the historical time window. This also basically meets most of the application scenarios of Feature Engineering.</p></li>
<li><p>Lower bound time of OpenMLDB must be &gt; = Upper bound time</p></li>
<li><p>The number of lower bounds of OpenMLDB must be &lt; = The number of upper bounds</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">INSTANCE_NOT_IN_WINDOW</span></code>: Mark as a secondary table splicing window. Except for the current row, other data in the main table will not enter the window.</p></li>
</ul>
<p>For more syntax and features, please refer to <a class="reference external" href="https://link.zhihu.com/?target=http%3A//docs-cn.openmldb.ai/2620896">OpenMLDB WINDOW UNION Reference Manual</a>.</p>
<p>The following describes the splicing window definition operation of WINDOW UNION through specific examples. For the user transaction table t1 mentioned above, we need to define the splicing window on the sub table of merchant flow table t2, which is based on <code class="docutils literal notranslate"><span class="pre">mid</span></code>. Because the schemas of t1 and t2 are different, we first extract the same columns from t1 and t2 respectively. For non-existent columns, you can configure default values. Among them, <code class="docutils literal notranslate"><span class="pre">mid</span></code> column is used for the splicing of two tables, so it is necessary. Secondly, the timestamp column（<code class="docutils literal notranslate"><span class="pre">trans_time</span></code> in t1 and <code class="docutils literal notranslate"><span class="pre">purchase_time</span></code> in t2）contains timing information, which is also necessary when defining the time window; The remaining columns are filtered and retained as required by the aggregation function.</p>
<p>The following SQL and schematic diagrams extract the necessary columns from t1 to generate t11.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t11</span><span class="w"></span>
</pre></div>
</div>
<p><img alt="img" src="../_images/t1_to_t11.jpg" /></p>
<p>The following SQL and diagram extract the necessary columns from t2 to generate t22.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t22</span><span class="w"></span>
</pre></div>
</div>
<p><img alt="img" src="../_images/t2_to_t22.jpg" /></p>
<p>It can be seen that the tables t11 and t22 generated after extraction have the same schema, and they can perform logical union operation. However, in OpenMLDB, the WINDOW UNION is not really for the UNION operation in the traditional database, but to build the time window on the sub table t22 for each sample row in t11. According to the merchant ID <code class="docutils literal notranslate"><span class="pre">mid</span></code> ，we obtain the corresponding splicing data from t22 for each row of data in t11, and then sort it according to the consumption time (<code class="docutils literal notranslate"><span class="pre">purchase_time</span></code>) to construct the sub table splicing window. For example, we define a <code class="docutils literal notranslate"><span class="pre">w_t2_10d</span></code> window: It does not include the data rows of the main table except the current row, plus the data within ten days spliced by the sub table through <code class="docutils literal notranslate"><span class="pre">mid</span></code>. The schematic diagram is as follows. It can be seen that the yellow and blue shaded parts define the sub table splicing windows of sample 6 and sample 9 respectively.</p>
<p><img alt="img" src="../_images/t11_t22.jpg" /></p>
<p>The SQL script of the window definition process is as follows (Note that this is not a complete SQL):</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchage_type</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t11</span><span class="w"></span>
<span class="n">window</span><span class="w"> </span><span class="n">w_t2_10d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t22</span><span class="w"> </span>
<span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">purchase_time</span><span class="w"></span>
<span class="n">ROWS_RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">10</span><span class="n">d</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="step-2-build-multi-row-aggregation-feature-of-sub-table">
<h2>3.2 Step 2: Build Multi-Row Aggregation Feature of Sub Table<a class="headerlink" href="#step-2-build-multi-row-aggregation-feature-of-sub-table" title="Permalink to this headline">#</a></h2>
<p>For the sub table splicing window, the multi-row aggregation function is processed to construct the multi-row sub table aggregation feature, so that the number of rows finally generated is the same as that of the main table. Taking the simple aggregation function as an example, we can construct the sub table splicing feature of the sample: The total retail sales of merchants in the last 10 days <code class="docutils literal notranslate"><span class="pre">w10d_merchant_purchase_amt_sum</span></code> and the total consumption times of the merchant in the last 10 days <code class="docutils literal notranslate"><span class="pre">w10d_merchant_purchase_count</span></code>. The following SQL constructs the multi-row aggregation feature based on the sub table splicing window defined in 3.1 above.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span>
<span class="n">id</span><span class="p">,</span><span class="w"> </span>
<span class="c1">-- Total retail sales of sample merchants in the last 10 days</span>
<span class="k">sum</span><span class="p">(</span><span class="n">purchase_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w_t2_10d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w10d_merchant_purchase_amt_sum</span><span class="p">,</span><span class="w"></span>
<span class="c1">-- Transaction times of sample merchants in the last 10 days</span>
<span class="k">count</span><span class="p">(</span><span class="n">purchase_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w_t2_10d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w10d_merchant_purchase_count</span><span class="w"> </span>
<span class="k">FROM</span><span class="w">   </span>
<span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t11</span><span class="w"></span>
<span class="n">window</span><span class="w"> </span><span class="n">w_t2_10d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t22</span><span class="w"> </span>
<span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">purchase_time</span><span class="w"></span>
<span class="n">ROWS_RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">10</span><span class="n">d</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="feature-group-construction">
<h2>4. Feature Group Construction<a class="headerlink" href="#feature-group-construction" title="Permalink to this headline">#</a></h2>
<p>Generally speaking, a complete feature extraction script will extract dozens, hundreds or even ten of hundreds of features. We can divide these features into several groups according to the feature type, the table and window associated with the feature, and then put each group of features into different SQL sub queries. Finally, these sub queries are spliced together according to the main table ID. In this section, we will continue the previous examples to demonstrate that if various features are spliced together to form a feature wide table.</p>
<p>First, we divide the features into 3 groups:</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>Feature Group</p></th>
<th class="head"><p>Feature Group Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>Single line characteristics of sample users (primary table) and sample merchants (secondary table)</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>Window aggregation characteristics of sample users (main table) in the last 30 days and window aggregation characteristics of users in the last 7 days</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>Aggregation characteristics of sample merchants (sub table) in the last 30 days</p></td>
</tr>
</tbody>
</table>
<p>Then, we use OpenMLDB SQL to build the same set of features in the same sub query:</p>
<ul class="simple">
<li><p>Feature Group 1</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">-- Main table single line features</span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Column direct extraction</span>
<span class="w">  </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Single line time characteristics：day of week</span>
<span class="w">  </span><span class="n">dayofweek</span><span class="p">(</span><span class="n">trans_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_trans_day_of_week</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Time characteristics of single line: Transaction day</span>
<span class="w">  </span><span class="k">day</span><span class="p">(</span><span class="n">trans_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_trans_day</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Single line time characteristics: Transaction hours</span>
<span class="w">  </span><span class="n">hour</span><span class="p">(</span><span class="n">trans_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_trans_hour</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Single line time characteristics: Transaction minutes</span>
<span class="w">  </span><span class="k">minute</span><span class="p">(</span><span class="n">trans_time</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Mathematical characteristics of single line: The transaction amount is rounded up and then taken as logarithm</span>
<span class="w">  </span><span class="n">log</span><span class="p">(</span><span class="n">ceiling</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_trans_amt_log</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Single line string feature: The first four digits of card number</span>
<span class="w">  </span><span class="n">substr</span><span class="p">(</span><span class="n">cardno</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Secondary table features</span>
<span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">purchase_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_purchase_time</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">purchase_amt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_purchase_amt</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">purchase_type</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_purchase_type</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">LAST</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">purchase_time</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">mid</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Feature Group 2</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">-- Main table window features</span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">out2id</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Total POS transaction amount in the last 30 days</span>
<span class="w">  </span><span class="n">sum_where</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;POS&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w30d_sum_pos_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Maximum POS transaction amount in the last 30 days</span>
<span class="w">  </span><span class="n">max_where</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;POS&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w30d_max_pos_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Average single POS transaction amount in the last 30 days</span>
<span class="w">  </span><span class="n">avg_where</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;POS&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w30d_avg_pos_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Total number of POS transactions in the last 30 days</span>
<span class="w">  </span><span class="n">count_where</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;POS&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w30d_count_pos_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">-- Total transaction amount in the last week</span>
<span class="w">  </span><span class="k">sum</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w7d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w7d_sum_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Total number of transactions in the last week</span>
<span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w7d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w7d_count_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Windows in the last 30 days</span>
<span class="w">  </span><span class="n">window</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="n">ROWS_RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">30</span><span class="n">d</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Last week&#39;s window</span>
<span class="w">  </span><span class="n">w7d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="n">ROWS_RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">7</span><span class="n">d</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<ul class="simple">
<li><p>Feature Group 3</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Side table aggregation feature</span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">out3id</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Total retail sales of sample merchants in the last week</span>
<span class="w">  </span><span class="k">sum</span><span class="p">(</span><span class="n">purchase_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w7d_merchant</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w7d_merchant_purchase_amt_sum</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Transaction times of sample merchants in the last week</span>
<span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="n">purchase_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w7d_merchant</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w7d_merchant_purchase_count</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Main table merchant&#39;s flow in the last week</span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">cardno</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">card</span><span class="p">,</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t11</span><span class="w"></span>
<span class="w">   </span><span class="n">window</span><span class="w"> </span><span class="n">w7d_merchant</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">card</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t22</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">purchase_time</span><span class="w"> </span><span class="n">ROWS_RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">30</span><span class="n">d</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Finally, the three groups of features are spliced together according to the main table ID:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span>
<span class="c1">-- Feature group 1</span>
<span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Main table single line features</span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Column direct extraction</span>
<span class="w">  </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">uid</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Single line time characteristics：Day of week</span>
<span class="w">  </span><span class="n">dayofweek</span><span class="p">(</span><span class="n">trans_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_trans_day_of_week</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Time characteristics of single line: Transaction day</span>
<span class="w">  </span><span class="k">day</span><span class="p">(</span><span class="n">trans_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_trans_day</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Single line time characteristics: Transaction hours</span>
<span class="w">  </span><span class="n">hour</span><span class="p">(</span><span class="n">trans_time</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_trans_hour</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="c1">-- Single line time characteristics: Transaction minutes</span>
<span class="w">  </span><span class="k">minute</span><span class="p">(</span><span class="n">trans_time</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Mathematical characteristics of single line: The transaction amount is rounded up and then taken as logarithm</span>
<span class="w">  </span><span class="n">log</span><span class="p">(</span><span class="n">ceiling</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_trans_amt_log</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Single line string feature: The first four digits of card number</span>
<span class="w">  </span><span class="n">substr</span><span class="p">(</span><span class="n">cardno</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">-- Secondary table features</span>
<span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">purchase_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_purchase_time</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">purchase_amt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_purchase_amt</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="n">t2</span><span class="p">.</span><span class="n">purchase_type</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">f_purchase_type</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">t1</span><span class="w"> </span><span class="k">LAST</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">purchase_time</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">mid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">mid</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">out1</span><span class="w"> </span><span class="k">LAST</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span>
<span class="c1">-- Feature group 2</span>
<span class="p">(</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Main table window features</span>
<span class="w">  </span><span class="k">SELECT</span><span class="w"> </span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">out2id</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Total POS transaction amount in the last 30 days</span>
<span class="w">  </span><span class="n">sum_where</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;POS&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w30d_sum_pos_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Maximum POS transaction amount in the last 30 days</span>
<span class="w">  </span><span class="n">max_where</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;POS&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w30d_max_pos_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Average single POS transaction amount in the last 30 days</span>
<span class="w">  </span><span class="n">avg_where</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;POS&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w30d_avg_pos_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Total number of POS transactions in the last 30 days</span>
<span class="w">  </span><span class="n">count_where</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">,</span><span class="w"> </span><span class="n">trans_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;POS&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w30d_count_pos_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span>
<span class="w">  </span><span class="c1">-- Total transaction amount in the last week</span>
<span class="w">  </span><span class="k">sum</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w7d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w7d_sum_trans_amt</span><span class="p">,</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Total number of transactions in the last week</span>
<span class="w">  </span><span class="k">count</span><span class="p">(</span><span class="n">trans_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w7d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w7d_count_trans_amt</span><span class="w"> </span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Windows in the last 30 days</span>
<span class="w">  </span><span class="n">window</span><span class="w"> </span><span class="n">w30d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="n">ROWS_RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">30</span><span class="n">d</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">),</span><span class="w"></span>
<span class="w">  </span><span class="c1">-- Last week&#39;s window</span>
<span class="w">  </span><span class="n">w7d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">uid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="n">ROWS_RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">7</span><span class="n">d</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">CURRENT</span><span class="w"> </span><span class="k">ROW</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">out2</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">out1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out2</span><span class="p">.</span><span class="n">out2id</span><span class="w"> </span><span class="k">LAST</span><span class="w"> </span><span class="k">JOIN</span><span class="w"></span>
<span class="c1">-- Feature group 3</span>
<span class="p">(</span><span class="w"></span>
<span class="w">   </span><span class="c1">-- Side table aggregation feature</span>
<span class="w">   </span><span class="k">SELECT</span><span class="w"></span>
<span class="w">   </span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">out3id</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="c1">-- Total retail sales of sample merchants in the last week</span>
<span class="w">   </span><span class="k">sum</span><span class="p">(</span><span class="n">purchase_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w7d_merchant</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w7d_merchant_purchase_amt_sum</span><span class="p">,</span><span class="w"></span>
<span class="w">   </span><span class="c1">-- Transaction times of sample merchants in the last week</span>
<span class="w">   </span><span class="k">count</span><span class="p">(</span><span class="n">purchase_amt</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">w7d_merchant</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">w7d_merchant_purchase_count</span><span class="w"></span>
<span class="w">   </span><span class="c1">-- Main table merchant&#39;s flow in the last week</span>
<span class="w">   </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">cardno</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">card</span><span class="p">,</span><span class="w"> </span><span class="n">trans_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;&quot;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t11</span><span class="w"></span>
<span class="w">   </span><span class="n">window</span><span class="w"> </span><span class="n">w7d_merchant</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mid</span><span class="p">,</span><span class="w"> </span><span class="n">card</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_time</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_amt</span><span class="p">,</span><span class="w"> </span><span class="n">purchase_type</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">t2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t22</span><span class="w"> </span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">mid</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">purchase_time</span><span class="w"> </span><span class="n">ROWS_RANGE</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="mi">30</span><span class="n">d</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">PRECEDING</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">)</span><span class="w"></span>
<span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">out3</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">out1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out3</span><span class="p">.</span><span class="n">out3id</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="extended-reading">
<h2>5. Extended Reading<a class="headerlink" href="#extended-reading" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://zhuanlan.zhihu.com/p/462559609">Open-source Machine Learning Database OpenMLDB v0.4.0 Product Introduction</a></p></li>
<li><p>Want to quickly try the OpenMLDB to start writing feature calculation scripts? Let’s take a look at <a class="reference external" href="http://docs-cn.openmldb.ai/2620852">OpenMLDB Quick Start</a></p></li>
<li><p>Complete SQL syntax reference document: <a class="reference external" href="http://docs-cn.openmldb.ai/2620876">China Mirror Site</a> and  <a class="reference external" href="https://docs.openmldb.ai/">International Site</a></p></li>
<li><p>The first part of this series of tutorials: <a class="reference external" href="https://zhuanlan.zhihu.com/p/467625760">4PD Developer Community: In Simple Terms, Feature Engineering - Practice Guide based on OpenMLDB (Part 1)</a></p></li>
</ul>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="tutorial_sql_1.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">SQL for Feature Extraction (Part 1)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="data_import.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Data Import</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By OpenMLDB<br/>
  
      &copy; Copyright 2022, OpenMLDB.<br/>
    Last updated on Aug 27, 2022, 3:54:29 PM.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>