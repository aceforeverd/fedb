
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>OpenMLDB + OneFlow: Prediction of Purchase Intention for High Potential Customers &#8212; OpenMLDB  documentation</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Deployment" href="../deploy/index.html" />
    <link rel="prev" title="Building End-to-End MLOps Workflows (OpenMLDB + DolphinScheduler)" href="dolphinscheduler_task_demo.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/openmldb_logo.png" class="logo" alt="logo">
      
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../about/index.html">
   About
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/intro.html">
     Introduction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/milestones.html">
     Milestones
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../about/release_notes.html">
     Release Notes
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../quickstart/index.html">
   Quickstart
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../quickstart/openmldb_quickstart.html">
     OpenMLDB Quickstart
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../quickstart/java_sdk.html">
     Java SDK Quickstart
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../quickstart/python_sdk.html">
     Python SDK Quickstart
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../quickstart/rest_api.html">
     REST APIs
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../tutorial/index.html">
   Tutorials
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/standalone_vs_cluster.html">
     Cluster vs. Standalone Versions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/modes.html">
     The Workflow of Cluster Version and Execution Mode
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/tutorial_sql_1.html">
     SQL for Feature Extraction (Part 1)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/tutorial_sql_2.html">
     SQL for Feature Extraction (Part 2)
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/data_import.html">
     Data Import
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorial/openmldbspark_distribution.html">
     OpenMLDB Spark Distribution
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Use Cases
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="lightgbm_demo.html">
     OpenMLDB + LightGBM: Taxi Trip Duration Prediction
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pulsar_connector_demo.html">
     Importing Real-Time Data Streams from Pulsar
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="kafka_connector_demo.html">
     Importing Real-Time Data Streams from Kafka
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="dolphinscheduler_task_demo.html">
     Building End-to-End MLOps Workflows (OpenMLDB + DolphinScheduler)
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     OpenMLDB + OneFlow: Prediction of Purchase Intention for High Potential Customers
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../deploy/index.html">
   Deployment
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../deploy/compile.html">
     Build
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../deploy/install_deploy.html">
     Install and Deploy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../deploy/conf.html">
     Configuration File
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../maintain/index.html">
   Maintenance
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/upgrade.html">
     Upgrade
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/backup.html">
     Backup and Restore
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/monitoring.html">
     Monitoring
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/cli.html">
     Operations in CLI
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/faq.html">
     Operation and Maintenance FAQ
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/scale.html">
     Scale-Out and Scale-In
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../maintain/diagnose.html">
     Diagnostic Tool
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../developer/index.html">
   Developers
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../developer/built_in_function_develop_guide.html">
     Built-In Function Development
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../reference/index.html">
   References
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../reference/arch/index.html">
     Architecture
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
    <label for="toctree-checkbox-9">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../reference/arch/online_arch.html">
       Online Module Architecture
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../reference/sql/index.html">
     SQL
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
    <label for="toctree-checkbox-10">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/language_structure/index.html">
       Language Structure
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
      <label for="toctree-checkbox-11">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/keywords.html">
         Keywords
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/object_names_identifiers.html">
         SQL Object Name
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/literals_value.html">
         Literal Value
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/case_sensitive.html">
         Case Sensitive
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/language_structure/comment.html">
         Notes
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/data_types/index.html">
       Data Type
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
      <label for="toctree-checkbox-12">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/data_types/numeric_types.html">
         Numeric Type
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/data_types/string_types.html">
         String Type
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/data_types/date_and_time_types.html">
         Date and Time Type
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/functions_and_operators/index.html">
       Expressions, Functions, and Operations
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
      <label for="toctree-checkbox-13">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/functions_and_operators/operators.html">
         Operator
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/functions_and_operators/Files/udfs_8h.html">
         Built-in Functions
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/dql/index.html">
       Data Query Statement （DQL）
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
      <label for="toctree-checkbox-14">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/SELECT_STATEMENT.html">
         SELECT Overview
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/JOIN_CLAUSE.html">
         JOIN Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/WHERE_CLAUSE.html">
         WHERE Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/GROUP_BY_CLAUSE.html">
         GROUP BY Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/HAVING_CLAUSE.html">
         Having Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/WINDOW_CLAUSE.html">
         WINDOW Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/LIMIT_CLAUSE.html">
         Limit Clause
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/NO_TABLE_SELECT_CLAUSE.html">
         No-table SELECT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dql/SELECT_INTO_STATEMENT.html">
         SELECT INTO
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/dml/index.html">
       Data Manipulation Statement（DML）
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
      <label for="toctree-checkbox-15">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dml/INSERT_STATEMENT.html">
         INSERT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dml/LOAD_DATA_STATEMENT.html">
         LOAD DATA INFILE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/dml/DELETE_STATEMENT.html">
         DELETE
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/ddl/index.html">
       Data Definition Statement (DDL)
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
      <label for="toctree-checkbox-16">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/CREATE_DATABASE_STATEMENT.html">
         CREATE DATABASE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/SHOW_DATABASES_STATEMENT.html">
         SHOW DATABASES
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/USE_DATABASE_STATEMENT.html">
         USE DATABASE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/DROP_DATABASE_STATEMENT.html">
         DROP DATABASE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/DESC_STATEMENT.html">
         DESC
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/CREATE_TABLE_STATEMENT.html">
         CREATE TABLE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/DROP_TABLE_STATEMENT.html">
         DROP TABLE
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/SHOW_TABLES_STATEMENT.html">
         SHOW TABLES
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/SHOW_VARIABLES_STATEMENT.html">
         SHOW VARIABLES
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/SET_STATEMENT.html">
         SET STATEMENT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/CREATE_INDEX_STATEMENT.html">
         CREATE INDEX
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/ddl/DROP_INDEX_STATEMENT.html">
         DROP INDEX
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/deployment_manage/index.html">
       DEPLOYMENT Management
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
      <label for="toctree-checkbox-17">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/DEPLOY_STATEMENT.html">
         DEPLOY
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/DROP_DEPLOYMENT_STATEMENT.html">
         Delete DEPLOYMENT
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/SHOW_DEPLOYMENTS.html">
         View DEPLOYMENTS List
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/SHOW_DEPLOYMENT.html">
         View DEPLOYMENT Details
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/deployment_manage/ONLINE_SERVING_REQUIREMENTS.html">
         SQL On-Line Specifications and Requirements
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3 has-children">
      <a class="reference internal" href="../reference/sql/task_manage/index.html">
       Task Management
      </a>
      <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
      <label for="toctree-checkbox-18">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/task_manage/SHOW_JOBS.html">
         SHOW JOBS
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/task_manage/SHOW_JOB.html">
         SHOW JOB
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/task_manage/STOP_JOB.html">
         STOP JOB
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../reference/sql/task_manage/SUBMIT_JOB.html">
         SUBMIT JOB
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../reference/ip_tips.html">
     IP Configuration
    </a>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../reference/client_config/index.html">
     Client Configuration
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
    <label for="toctree-checkbox-19">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../reference/client_config/client_spark_config.html">
       Spark Client Configuration
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav>
</br>
Current Version: main</br>
Versions：
<ul>
  <li><a href="JD_recommendation_en.html">main</a></li>
  <li><a href="../../v0.5/index.html">v0.5</a></li>
  <li><a href="../../v0.4/index.html">v0.4</a></li>
  <li><a href="../../v0.6/index.html">v0.6</a></li>
</ul>
</br>
</div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/use_case/JD_recommendation_en.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preparation-and-preliminary-knowledge">
   1. Preparation and Preliminary Knowledge
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#oneflow-installation">
     1.1 OneFlow Installation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pull-and-start-the-openmldb-docker-image">
     1.2 Pull and Start the OpenMLDB Docker Image
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initialize-environment">
     1.3  Initialize Environment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#start-openmldb-cli-client">
     1.4 Start OpenMLDB CLI Client
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preliminary-knowledge-non-blocking-task-of-cluster-version">
     1.5 Preliminary Knowledge: Non-Blocking Task of Cluster Version
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#machine-learning-process-based-on-openmldb-and-oneflow">
   2. Machine Learning Process Based on OpenMLDB and OneFlow
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview">
     2.1 Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#offline-feature-extraction-with-openmldb">
     2.2 Offline feature extraction with OpenMLDB
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#creating-databases-and-data-tables">
       2.2.1 Creating Databases and Data Tables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#offline-data-preparation">
       2.2.2 Offline Data Preparation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-feature-extraction-script">
       2.2.3 The Feature Extraction Script
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#offline-feature-extraction">
       2.2.4 Offline Feature Extraction
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-process-dataset-to-match-deepfm-model-requirements">
     2.3 Pre-process Dataset to Match DeepFM Model Requirements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#launch-oneflow-for-model-training">
     2.4 Launch OneFlow for Model Training
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#update-train-deepfm-sh-configuration-file">
       2.4.1 Update
       <code class="docutils literal notranslate">
        <span class="pre">
         train_deepfm.sh
        </span>
       </code>
       Configuration File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#start-model-training">
       2.4.2 Start Model Training
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-serving">
   3. Model Serving
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     3.1 Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configure-openmldb-for-online-feature-extraction">
     3.2 Configure OpenMLDB for Online Feature Extraction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#online-sql-deployment">
       3.2.1 Online SQL Deployment
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#online-data-import">
       3.2.2 Online Data Import
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configure-oneflow-model-serving">
     3.3 Configure OneFlow Model Serving
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#check-model-path-demodir-oneflow-process-model">
       3.3.1 Check Model Path (
       <code class="docutils literal notranslate">
        <span class="pre">
         $demodir/oneflow_process/model
        </span>
       </code>
       )
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#check-config-pbtxt-configurations">
       3.3.2 Check
       <code class="docutils literal notranslate">
        <span class="pre">
         config.pbtxt
        </span>
       </code>
       configurations.
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#check-persistent-demodir-oneflow-process-persistent-path">
       3.3.3 Check persistent (
       <code class="docutils literal notranslate">
        <span class="pre">
         $demodir/oneflow_process/persistent
        </span>
       </code>
       ) path
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#start-serving">
     3.4 Start Serving
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#start-openmldb-serving">
       3.4.1 Start OpenMLDB Serving
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#start-oneflow-model-serving">
       3.4.2 Start OneFlow Model Serving
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#send-real-time-request">
     3.5 Send Real-Time Request
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-a-oneflow-compilation">
   Appendix A – OneFlow Compilation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-1-docker-image">
     A.1 Docker image
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-2-oneflow-compilation">
     A.2 OneFlow Compilation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-3-serving-compilation">
     A.3 Serving Compilation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-4-test-tritonserver">
     A.4 Test TritonServer
    </a>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>OpenMLDB + OneFlow: Prediction of Purchase Intention for High Potential Customers</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preparation-and-preliminary-knowledge">
   1. Preparation and Preliminary Knowledge
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#oneflow-installation">
     1.1 OneFlow Installation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pull-and-start-the-openmldb-docker-image">
     1.2 Pull and Start the OpenMLDB Docker Image
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#initialize-environment">
     1.3  Initialize Environment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#start-openmldb-cli-client">
     1.4 Start OpenMLDB CLI Client
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preliminary-knowledge-non-blocking-task-of-cluster-version">
     1.5 Preliminary Knowledge: Non-Blocking Task of Cluster Version
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#machine-learning-process-based-on-openmldb-and-oneflow">
   2. Machine Learning Process Based on OpenMLDB and OneFlow
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#overview">
     2.1 Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#offline-feature-extraction-with-openmldb">
     2.2 Offline feature extraction with OpenMLDB
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#creating-databases-and-data-tables">
       2.2.1 Creating Databases and Data Tables
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#offline-data-preparation">
       2.2.2 Offline Data Preparation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#the-feature-extraction-script">
       2.2.3 The Feature Extraction Script
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#offline-feature-extraction">
       2.2.4 Offline Feature Extraction
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pre-process-dataset-to-match-deepfm-model-requirements">
     2.3 Pre-process Dataset to Match DeepFM Model Requirements
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#launch-oneflow-for-model-training">
     2.4 Launch OneFlow for Model Training
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#update-train-deepfm-sh-configuration-file">
       2.4.1 Update
       <code class="docutils literal notranslate">
        <span class="pre">
         train_deepfm.sh
        </span>
       </code>
       Configuration File
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#start-model-training">
       2.4.2 Start Model Training
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-serving">
   3. Model Serving
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     3.1 Overview
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configure-openmldb-for-online-feature-extraction">
     3.2 Configure OpenMLDB for Online Feature Extraction
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#online-sql-deployment">
       3.2.1 Online SQL Deployment
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#online-data-import">
       3.2.2 Online Data Import
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#configure-oneflow-model-serving">
     3.3 Configure OneFlow Model Serving
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#check-model-path-demodir-oneflow-process-model">
       3.3.1 Check Model Path (
       <code class="docutils literal notranslate">
        <span class="pre">
         $demodir/oneflow_process/model
        </span>
       </code>
       )
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#check-config-pbtxt-configurations">
       3.3.2 Check
       <code class="docutils literal notranslate">
        <span class="pre">
         config.pbtxt
        </span>
       </code>
       configurations.
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#check-persistent-demodir-oneflow-process-persistent-path">
       3.3.3 Check persistent (
       <code class="docutils literal notranslate">
        <span class="pre">
         $demodir/oneflow_process/persistent
        </span>
       </code>
       ) path
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#start-serving">
     3.4 Start Serving
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#start-openmldb-serving">
       3.4.1 Start OpenMLDB Serving
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#start-oneflow-model-serving">
       3.4.2 Start OneFlow Model Serving
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#send-real-time-request">
     3.5 Send Real-Time Request
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#appendix-a-oneflow-compilation">
   Appendix A – OneFlow Compilation
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-1-docker-image">
     A.1 Docker image
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-2-oneflow-compilation">
     A.2 OneFlow Compilation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-3-serving-compilation">
     A.3 Serving Compilation
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a-4-test-tritonserver">
     A.4 Test TritonServer
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="openmldb-oneflow-prediction-of-purchase-intention-for-high-potential-customers">
<h1>OpenMLDB + OneFlow: Prediction of Purchase Intention for High Potential Customers<a class="headerlink" href="#openmldb-oneflow-prediction-of-purchase-intention-for-high-potential-customers" title="Permalink to this headline">#</a></h1>
<p>In this article, we will use <a class="reference external" href="https://jdata.jd.com/html/detail.html?id=1">JD Prediction of purchase intention for high potential customers problem</a> as a demonstration，to show how we can use <a class="reference external" href="https://github.com/4paradigm/OpenMLDB">OpenMLDB</a> and <a class="reference external" href="https://github.com/Oneflow-Inc/oneflow">OneFlow</a> together to build a complete machine learning application. Full dataset <a class="reference external" href="https://openmldb.ai/download/jd-recommendation/JD_data.tgz">download here</a>.</p>
<p>Extracting patterns from historical data to predict the future purchase intentions, to bring together the most suitable products and customers who need them most, is the key issue in the application of big data in precision marketing, and is also the key technology in digitalization for all e-commerce platforms. As the largest self-operated e-commerce company in China, <a class="reference external" href="http://JD.com">JD.com</a> has accumulated hundreds of millions of loyal customers and massive amounts of real-life data. This demonstration is based on the real-life data, including real customers, product and behavior data (after desensitization) from Jingdong Mall, and utilizes data mining technology and machine learning algorithm to build a prediction model for user purchase intentions, and output matching results between high-potential customers and target products. This aims to provide high-quality target groups for precision marketing, mine the potential meaning behind the data, and provide e-commerce customers with a simpler, faster and more worry-free shopping experience. In this demonstration, OpenMLDB is used for data mining, and the <a class="reference external" href="https://github.com/Oneflow-Inc/models/tree/main/RecommenderSystems/deepfm">DeepFM</a> model in OneFlow is used for high-performance training and inference to provide accurate product recommendations.</p>
<p>Note that: (1) this case is based on the OpenMLDB cluster version for tutorial demonstration; (2) this document uses the pre-compiled docker image. If you want to test it in the OpenMLDB environment compiled and built by yourself, you need to configure and use our <a class="reference external" href="https://github.com/4paradigm/spark">Spark Distribution for Feature Engineering Optimization</a>. Please refer to relevant documents of <a class="reference external" href="https://openmldb.ai/docs/en/main/deploy/compile.html">compilation</a> (Refer to Chapter: “Spark Distribution Optimized for OpenMLDB”) and the <a class="reference external" href="https://openmldb.ai/docs/en/main/deploy/install_deploy.html">installation and deployment documents</a> (Refer to the section: <a class="reference external" href="https://openmldb.ai/docs/en/main/deploy/install_deploy.html#deploy-taskmanager">Deploy TaskManager</a>).</p>
<section id="preparation-and-preliminary-knowledge">
<h2>1. Preparation and Preliminary Knowledge<a class="headerlink" href="#preparation-and-preliminary-knowledge" title="Permalink to this headline">#</a></h2>
<section id="oneflow-installation">
<h3>1.1 OneFlow Installation<a class="headerlink" href="#oneflow-installation" title="Permalink to this headline">#</a></h3>
<p>OneFlow framework leverage on the great computational power from GPU. Therefore please ensure that the machines for deployment are equipped with NVidia GPUs, and ensure the driver version is &gt;=460.X.X  <a class="reference external" href="https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html#cuda-major-component-versions">driver version support for CUDA 11.0</a>.
Install OneFlow with the following commands：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda activate oneflow
python3 -m pip install --pre oneflow -f https://staging.oneflow.info/branch/support_oneembedding_serving/cu102
</pre></div>
</div>
<p>In addition, following Python packages need to be installed:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install psutil petastorm pandas sklearn
</pre></div>
</div>
</section>
<section id="pull-and-start-the-openmldb-docker-image">
<h3>1.2 Pull and Start the OpenMLDB Docker Image<a class="headerlink" href="#pull-and-start-the-openmldb-docker-image" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Note: Please make sure that the Docker Engine version number is &gt; = 18.03</p></li>
<li><p>Pull the OpenMLDB docker image and run the corresponding container</p></li>
<li><p>Download demo files, and map the demo directory to <code class="docutils literal notranslate"><span class="pre">/root/project</span></code>, here we use <code class="docutils literal notranslate"><span class="pre">demodir=/home/gtest/demo</span></code>. The demo files include scripts and sample training data required for this case.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">demodir</span><span class="o">=</span>/home/gtest/demo
docker run -dit --name<span class="o">=</span>demo --network<span class="o">=</span>host -v <span class="nv">$demodir</span>:/root/project 4pdosc/openmldb:0.5.2 bash
docker <span class="nb">exec</span> -it demo bash
</pre></div>
</div>
<ul class="simple">
<li><p>The image is preinstalled with OpenMLDB and some third-party libraries and tools, we need to install the dependencies of OneFlow.</p></li>
</ul>
<p>Since we embed the data pre-processing and invoking of OneFlow serving in the OpenMLDB docker, following dependencies needs to be installed.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install tritonclient xxhash geventhttpclient
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that all the commands for OpenMLDB part below run in the docker container by default. All the commands for OneFlow are to run in the environment as installed in 1.1.</p>
</div>
</section>
<section id="initialize-environment">
<h3>1.3  Initialize Environment<a class="headerlink" href="#initialize-environment" title="Permalink to this headline">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./init.sh
</pre></div>
</div>
<p>We provide the <a class="reference external" href="http://init.sh">init.sh</a> script in the image that helps users to quickly initialize the environment including:</p>
<ul class="simple">
<li><p>Configure zookeeper</p></li>
<li><p>Start cluster version OpenMLDB</p></li>
</ul>
</section>
<section id="start-openmldb-cli-client">
<h3>1.4 Start OpenMLDB CLI Client<a class="headerlink" href="#start-openmldb-cli-client" title="Permalink to this headline">#</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>/work/openmldb/bin/openmldb --zk_cluster<span class="o">=</span><span class="m">127</span>.0.0.1:2181 --zk_root_path<span class="o">=</span>/openmldb --role<span class="o">=</span>sql_client
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that most of the commands in this tutorial are executed under the OpenMLDB CLI. In order to distinguish from the ordinary shell environment, the commands executed under the OpenMLDB CLI use a special prompt of &gt;.</p>
</div>
</section>
<section id="preliminary-knowledge-non-blocking-task-of-cluster-version">
<h3>1.5 Preliminary Knowledge: Non-Blocking Task of Cluster Version<a class="headerlink" href="#preliminary-knowledge-non-blocking-task-of-cluster-version" title="Permalink to this headline">#</a></h3>
<p>Some commands in the cluster version are non-blocking tasks, including <code class="docutils literal notranslate"><span class="pre">LOAD</span> <span class="pre">DATA</span></code> in online mode and <code class="docutils literal notranslate"><span class="pre">LOAD</span> <span class="pre">DATA</span></code>, <code class="docutils literal notranslate"><span class="pre">SELECT</span></code>, <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">INTO</span></code> commands in the offline mode. After submitting a task, you can use relevant commands such as <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">JOBS</span></code> and <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">JOB</span></code> to view the task progress. For details, see the offline task management document.</p>
</section>
</section>
<section id="machine-learning-process-based-on-openmldb-and-oneflow">
<h2>2. Machine Learning Process Based on OpenMLDB and OneFlow<a class="headerlink" href="#machine-learning-process-based-on-openmldb-and-oneflow" title="Permalink to this headline">#</a></h2>
<section id="overview">
<h3>2.1 Overview<a class="headerlink" href="#overview" title="Permalink to this headline">#</a></h3>
<p>Machine learning with OpenMLDB and OneFlow can be summarized into a few main steps. We will detail each step in the following sections.</p>
</section>
<section id="offline-feature-extraction-with-openmldb">
<h3>2.2 Offline feature extraction with OpenMLDB<a class="headerlink" href="#offline-feature-extraction-with-openmldb" title="Permalink to this headline">#</a></h3>
<section id="creating-databases-and-data-tables">
<h4>2.2.1 Creating Databases and Data Tables<a class="headerlink" href="#creating-databases-and-data-tables" title="Permalink to this headline">#</a></h4>
<p>The following commands are executed in the OpenMLDB CLI environment.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">JD_db</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">JD_db</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">action</span><span class="p">(</span><span class="n">reqId</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">eventTime</span><span class="w"> </span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">ingestionTime</span><span class="w"> </span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">actionValue</span><span class="w"> </span><span class="nb">int</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">flattenRequest</span><span class="p">(</span><span class="n">reqId</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">eventTime</span><span class="w"> </span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">main_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">pair_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">sku_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">split_id</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">time1</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_user</span><span class="p">(</span><span class="n">ingestionTime</span><span class="w"> </span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">sex</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">user_lv_cd</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">user_reg_tm</span><span class="w"> </span><span class="nb">bigint</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_action</span><span class="p">(</span><span class="n">ingestionTime</span><span class="w"> </span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">pair_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">model_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">cate</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_product</span><span class="p">(</span><span class="n">ingestionTime</span><span class="w"> </span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">sku_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">a1</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">a2</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">a3</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">cate</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">br</span><span class="w"> </span><span class="n">string</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_comment</span><span class="p">(</span><span class="n">ingestionTime</span><span class="w"> </span><span class="k">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">sku_id</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">comment_num</span><span class="w"> </span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">has_bad_comment</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">bad_comment_rate</span><span class="w"> </span><span class="nb">float</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>You can also use sql script to execute (<code class="docutils literal notranslate"><span class="pre">/root/project/create_tables.sql</span></code>) as shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openmldb</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">zk_cluster</span><span class="o">=</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">2181</span> <span class="o">--</span><span class="n">zk_root_path</span><span class="o">=/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">role</span><span class="o">=</span><span class="n">sql_client</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">create_tables</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
</section>
<section id="offline-data-preparation">
<h4>2.2.2 Offline Data Preparation<a class="headerlink" href="#offline-data-preparation" title="Permalink to this headline">#</a></h4>
<p>First, you need to switch to offline execution mode. Next, import the sample data as offline data for offline feature calculation.</p>
<p>The following commands are executed under the OpenMLDB CLI.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">JD_db</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="n">execute_mode</span><span class="o">=</span><span class="s1">&#39;offline&#39;</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/action/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;overwrite&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/flattenRequest_clean/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">flattenRequest</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;overwrite&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/bo_user/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_user</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;overwrite&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/bo_action/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_action</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;overwrite&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/bo_product/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_product</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;overwrite&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/bo_comment/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_comment</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;overwrite&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>or use script to execute, and check the job status with the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openmldb</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">zk_cluster</span><span class="o">=</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">2181</span> <span class="o">--</span><span class="n">zk_root_path</span><span class="o">=/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">role</span><span class="o">=</span><span class="n">sql_client</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">load_data</span><span class="o">.</span><span class="n">sql</span>

<span class="n">echo</span> <span class="s2">&quot;show jobs;&quot;</span> <span class="o">|</span> <span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openmldb</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">zk_cluster</span><span class="o">=</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">2181</span> <span class="o">--</span><span class="n">zk_root_path</span><span class="o">=/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">role</span><span class="o">=</span><span class="n">sql_client</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that <code class="docutils literal notranslate"><span class="pre">LOAD</span> <span class="pre">DATA</span></code> is a non-blocking task. You can use the command <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">JOBS</span></code> to view the running status of the task. Please wait for the task to run successfully (<code class="docutils literal notranslate"><span class="pre">state</span></code> to <code class="docutils literal notranslate"><span class="pre">FINISHED</span></code> status) before proceeding to the next step.</p>
</div>
</section>
<section id="the-feature-extraction-script">
<h4>2.2.3 The Feature Extraction Script<a class="headerlink" href="#the-feature-extraction-script" title="Permalink to this headline">#</a></h4>
<p>Usually, users need to analyse the data according to the goal of machine learning before designing the features, and then design and investigate the features according to the analysis. Data analysis and feature research of the machine learning are not the scope of this demo, and we will not expand it. We assume that users already have the basic theoretical knowledge of machine learning, the ability to solve machine learning problems, the ability to understand SQL syntax, and the ability to use SQL syntax to construct features. For this case, we have designed several features after the analysis and research.</p>
</section>
<section id="offline-feature-extraction">
<h4>2.2.4 Offline Feature Extraction<a class="headerlink" href="#offline-feature-extraction" title="Permalink to this headline">#</a></h4>
<p>In the offline mode, the user extracts features and outputs the feature results to <code class="docutils literal notranslate"><span class="pre">'/root/project/out/1</span></code>(mapped to<code class="docutils literal notranslate"><span class="pre">$demodir/out/1</span></code>) that is saved in the data directory for subsequent model training. The <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> command corresponds to the SQL feature extraction script generated based on the above table. The following commands are executed under the OpenMLDB CLI.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">JD_db</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="k">select</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId_1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_eventTime_original_0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_reqId_original_1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_original_24</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_sku_id_original_25</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_user_id_original_26</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_unique_count_27</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_top1_ratio</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_top1_ratio_28</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_top1_ratio</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0s_14d_200</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_top1_ratio_29</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0s_14d_200</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_unique_count_32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="o">!</span><span class="k">isnull</span><span class="p">(</span><span class="k">at</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">count_where</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">at</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_count_35</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dayofweek</span><span class="p">(</span><span class="k">timestamp</span><span class="p">(</span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_eventTime_dayofweek_41</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dayofweek</span><span class="p">(</span><span class="k">timestamp</span><span class="p">(</span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="p">))</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">dayofweek</span><span class="p">(</span><span class="k">timestamp</span><span class="p">(</span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_eventTime_isweekday_43</span><span class="w"></span>
<span class="k">from</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="w"></span>
<span class="w">    </span><span class="n">window</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">preceding</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">flattenRequest_user_id_eventTime_0s_14d_200</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">14</span><span class="n">d</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">200</span><span class="p">))</span><span class="w"></span>
<span class="k">as</span><span class="w"> </span><span class="n">out0</span><span class="w"></span>
<span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="k">select</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId_3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">action_reqId</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">actionValue</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">action_actionValue_multi_direct_2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">a1</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_a1_multi_direct_3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">a2</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_a2_multi_direct_4</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">a3</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_a3_multi_direct_5</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_br_multi_direct_6</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_cate_multi_direct_7</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_ingestionTime_multi_direct_8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_user_age_multi_direct_9</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_user_ingestionTime_multi_direct_10</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">sex</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_user_sex_multi_direct_11</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">user_lv_cd</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_user_user_lv_cd_multi_direct_12</span><span class="w"></span>
<span class="k">from</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="w"></span>
<span class="w">    </span><span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">action</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">action_reqId</span><span class="o">`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">action_reqId</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"></span>
<span class="w">    </span><span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">bo_product</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"></span>
<span class="w">    </span><span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">bo_user</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="p">)</span><span class="w"></span>
<span class="k">as</span><span class="w"> </span><span class="n">out1</span><span class="w"></span>
<span class="k">on</span><span class="w"> </span><span class="n">out0</span><span class="p">.</span><span class="n">reqId_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out1</span><span class="p">.</span><span class="n">reqId_3</span><span class="w"></span>
<span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="k">select</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId_14</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_bad_comment_rate_multi_max_13</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">min</span><span class="p">(</span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_bad_comment_rate_multi_min_14</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">min</span><span class="p">(</span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_bad_comment_rate_multi_min_15</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_comment_num_multi_unique_count_22</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_has_bad_comment_multi_unique_count_23</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_has_bad_comment_multi_top3frequency_30</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_comment_num_multi_top3frequency_33</span><span class="w"></span>
<span class="k">from</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">dt</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">window</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">dt</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_comment</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">64</span><span class="n">d</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">bo_comment_sku_id_ingestionTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">dt</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_comment</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">))</span><span class="w"></span>
<span class="k">as</span><span class="w"> </span><span class="n">out2</span><span class="w"></span>
<span class="k">on</span><span class="w"> </span><span class="n">out0</span><span class="p">.</span><span class="n">reqId_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out2</span><span class="p">.</span><span class="n">reqId_14</span><span class="w"></span>
<span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="k">select</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId_17</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_10h_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_br_multi_top3frequency_16</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_10h_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_cate_multi_top3frequency_17</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_7d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_model_id_multi_top3frequency_18</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_14d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_model_id_multi_unique_count_19</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_7d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_model_id_multi_unique_count_20</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_14d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_type_multi_unique_count_21</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_7d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_type_multi_top3frequency_40</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_14d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_type_multi_top3frequency_42</span><span class="w"></span>
<span class="k">from</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">window</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_10h_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_action</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">10</span><span class="n">h</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">bo_action_pair_id_ingestionTime_0s_7d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_action</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">7</span><span class="n">d</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">bo_action_pair_id_ingestionTime_0s_14d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_action</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">14</span><span class="n">d</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">))</span><span class="w"></span>
<span class="k">as</span><span class="w"> </span><span class="n">out3</span><span class="w"></span>
<span class="k">on</span><span class="w"> </span><span class="n">out0</span><span class="p">.</span><span class="n">reqId_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out3</span><span class="p">.</span><span class="n">reqId_17</span><span class="w"></span>
<span class="k">INTO</span><span class="w"> </span><span class="n">OUTFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/out/1&#39;</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>Since there is only one command, we can directly execute the sql script <code class="docutils literal notranslate"><span class="pre">sync_select_out.sql</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openmldb</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">zk_cluster</span><span class="o">=</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">2181</span> <span class="o">--</span><span class="n">zk_root_path</span><span class="o">=/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">role</span><span class="o">=</span><span class="n">sql_client</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">sync_select_out</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the cluster version <code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">INTO</span></code> is a non-blocking task. You can use the command <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">JOBS</span></code> to view the running status of the task. Please wait for the task to run successfully (<code class="docutils literal notranslate"><span class="pre">state</span></code> to <code class="docutils literal notranslate"><span class="pre">FINISHED</span></code> status) before proceeding to the next step.</p>
</div>
</section>
</section>
<section id="pre-process-dataset-to-match-deepfm-model-requirements">
<h3>2.3 Pre-process Dataset to Match DeepFM Model Requirements<a class="headerlink" href="#pre-process-dataset-to-match-deepfm-model-requirements" title="Permalink to this headline">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that following commands are executed outside the demo docker. They are executed in the environment as installed in section 1.1.</p>
</div>
<p>According to <a class="reference external" href="https://arxiv.org/abs/1703.04247">DeepFM paper</a>, we treat both categorical and continuous features as sparse features.</p>
<blockquote>
<div><p>χ may include categorical fields (e.g., gender, location) and continuous fields (e.g., age). Each categorical field is represented as a vector of one-hot encoding, and each continuous field is represented as the value itself, or a vector of one-hot encoding after discretization.</p>
</div></blockquote>
<p>Change directory to demo directory and execute the following commands to process the data set.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$demodir</span>/openmldb_process/
sh process_JD_out_full.sh <span class="nv">$demodir</span>/out/1
</pre></div>
</div>
<p>The generated dataset will be placed at <code class="docutils literal notranslate"><span class="pre">$demodir/openmldb_process/out</span></code>. After generating parquet dataset, dataset information will also be printed. It contains the information about the number of samples and table size array, which is needed when training.</p>
<blockquote>
<div><p>train samples = 4007924
val samples = 504398
test samples = 530059
table size array:
11,42,1105,200,11,1295,1,1,5,3,23,23,7,5042381,3127923,5042381,3649642,28350,105180,7,2,5042381,5,4,4,41,2,2,8,3456,4,5,5042381,10,60,5042381,843,17,1276,101,100</p>
</div></blockquote>
</section>
<section id="launch-oneflow-for-model-training">
<h3>2.4 Launch OneFlow for Model Training<a class="headerlink" href="#launch-oneflow-for-model-training" title="Permalink to this headline">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that following commands are executed in the environment as installed in section 1.1.</p>
</div>
<section id="update-train-deepfm-sh-configuration-file">
<h4>2.4.1 Update <code class="docutils literal notranslate"><span class="pre">train_deepfm.sh</span></code> Configuration File<a class="headerlink" href="#update-train-deepfm-sh-configuration-file" title="Permalink to this headline">#</a></h4>
<p>The dataset information generated from the previous section need to be updated in the configuration file,including <code class="docutils literal notranslate"><span class="pre">num_train_samples</span></code>,<code class="docutils literal notranslate"><span class="pre">num_val_samples</span></code>,<code class="docutils literal notranslate"><span class="pre">num_test_samples</span></code> and <code class="docutils literal notranslate"><span class="pre">table_size_array</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> <span class="nv">$demodir</span>/oneflow_process/
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="nv">DEVICE_NUM_PER_NODE</span><span class="o">=</span><span class="m">1</span>
<span class="nv">demodir</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
<span class="nv">DATA_DIR</span><span class="o">=</span><span class="nv">$demodir</span>/openmldb_process/out
<span class="nv">PERSISTENT_PATH</span><span class="o">=</span>/<span class="nv">$demodir</span>/oneflow_process/persistent
<span class="nv">MODEL_SAVE_DIR</span><span class="o">=</span><span class="nv">$demodir</span>/oneflow_process/model_out
<span class="nv">MODEL_SERVING_PATH</span><span class="o">=</span><span class="nv">$demodir</span>/oneflow_process/model/embedding/1/model

python3 -m oneflow.distributed.launch <span class="se">\</span>
--nproc_per_node <span class="nv">$DEVICE_NUM_PER_NODE</span> <span class="se">\</span>
--nnodes <span class="m">1</span> <span class="se">\</span>
--node_rank <span class="m">0</span> <span class="se">\</span>
--master_addr <span class="m">127</span>.0.0.1 <span class="se">\</span>
deepfm_train_eval_JD.py <span class="se">\</span>
--disable_fusedmlp <span class="se">\</span>
--data_dir <span class="nv">$DATA_DIR</span> <span class="se">\</span>
--persistent_path <span class="nv">$PERSISTENT_PATH</span> <span class="se">\</span>
--table_size_array <span class="s2">&quot;4,26,16,4,11,809,1,1,5,3,17,16,7,13916,13890,13916,10000,3674,9119,7,2,13916,5,4,4,33,2,2,7,2580,3,5,13916,10,47,13916,365,17,132,32,37&quot;</span> <span class="se">\</span>
--store_type <span class="s1">&#39;cached_host_mem&#39;</span> <span class="se">\</span>
--cache_memory_budget_mb <span class="m">1024</span> <span class="se">\</span>
--batch_size <span class="m">1000</span> <span class="se">\</span>
--train_batches <span class="m">75000</span> <span class="se">\</span>
--loss_print_interval <span class="m">100</span> <span class="se">\</span>
--dnn <span class="s2">&quot;1000,1000,1000,1000,1000&quot;</span> <span class="se">\</span>
--net_dropout <span class="m">0</span>.2 <span class="se">\</span>
--learning_rate <span class="m">0</span>.001 <span class="se">\</span>
--embedding_vec_size <span class="m">16</span> <span class="se">\</span>
--num_train_samples <span class="m">11073</span> <span class="se">\</span>
--num_val_samples <span class="m">1351</span> <span class="se">\</span>
--num_test_samples <span class="m">1492</span> <span class="se">\</span>
--model_save_dir <span class="nv">$MODEL_SAVE_DIR</span> <span class="se">\</span>
--save_best_model <span class="se">\</span>
--save_graph_for_serving <span class="se">\</span>
--model_serving_path <span class="nv">$MODEL_SERVING_PATH</span> <span class="se">\</span>
--save_model_after_each_eval
</pre></div>
</div>
</section>
<section id="start-model-training">
<h4>2.4.2 Start Model Training<a class="headerlink" href="#start-model-training" title="Permalink to this headline">#</a></h4>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>bash train_deepfm.sh <span class="nv">$demodir</span>
</pre></div>
</div>
<p>Trained model will be saved in <code class="docutils literal notranslate"><span class="pre">$demodir/oneflow_process/model_out</span></code>, saved model for serving will be saved in <code class="docutils literal notranslate"><span class="pre">$demodir/oneflow_process/model/embedding/1/model</span></code>.</p>
</section>
</section>
</section>
<section id="model-serving">
<h2>3. Model Serving<a class="headerlink" href="#model-serving" title="Permalink to this headline">#</a></h2>
<section id="id1">
<h3>3.1 Overview<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>Model serving with OpenMLDB+OneFlow can be summarized into a few main steps. We will detail each step in the following sections.</p>
</section>
<section id="configure-openmldb-for-online-feature-extraction">
<h3>3.2 Configure OpenMLDB for Online Feature Extraction<a class="headerlink" href="#configure-openmldb-for-online-feature-extraction" title="Permalink to this headline">#</a></h3>
<section id="online-sql-deployment">
<h4>3.2.1 Online SQL Deployment<a class="headerlink" href="#online-sql-deployment" title="Permalink to this headline">#</a></h4>
<p>Assuming that the model produced by the features designed in Section 2.2.3 in the previous model training meets the expectation. The next step is to deploy the feature extraction SQL script online to provide real-time feature extraction.</p>
<ol class="arabic">
<li><p>Restart OpenMLDB CLI for SQL online deployment.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker <span class="nb">exec</span> -it demo bash
/work/openmldb/bin/openmldb --zk_cluster<span class="o">=</span><span class="m">127</span>.0.0.1:2181 --zk_root_path<span class="o">=</span>/openmldb --role<span class="o">=</span>sql_client
</pre></div>
</div>
</li>
<li><p>To execute online deployment, the following commands are executed in OpenMLDB CLI.</p></li>
</ol>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">JD_db</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="n">execute_mode</span><span class="o">=</span><span class="s1">&#39;online&#39;</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">deploy</span><span class="w"> </span><span class="n">demo</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="k">select</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId_1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_eventTime_original_0</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_reqId_original_1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_original_24</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_sku_id_original_25</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_user_id_original_26</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_unique_count_27</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_top1_ratio</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_top1_ratio_28</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_top1_ratio</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0s_14d_200</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_top1_ratio_29</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0s_14d_200</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_unique_count_32</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="o">!</span><span class="k">isnull</span><span class="p">(</span><span class="k">at</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">count_where</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">at</span><span class="p">(</span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_pair_id_window_count_35</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">dayofweek</span><span class="p">(</span><span class="k">timestamp</span><span class="p">(</span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="p">))</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_eventTime_dayofweek_41</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dayofweek</span><span class="p">(</span><span class="k">timestamp</span><span class="p">(</span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="p">))</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">dayofweek</span><span class="p">(</span><span class="k">timestamp</span><span class="p">(</span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="p">))</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">flattenRequest_eventTime_isweekday_43</span><span class="w"></span>
<span class="k">from</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="w"></span>
<span class="w">    </span><span class="n">window</span><span class="w"> </span><span class="n">flattenRequest_user_id_eventTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">preceding</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">flattenRequest_user_id_eventTime_0s_14d_200</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">14</span><span class="n">d</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">200</span><span class="p">))</span><span class="w"></span>
<span class="k">as</span><span class="w"> </span><span class="n">out0</span><span class="w"></span>
<span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="k">select</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId_3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">action_reqId</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">actionValue</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">action_actionValue_multi_direct_2</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">a1</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_a1_multi_direct_3</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">a2</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_a2_multi_direct_4</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">a3</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_a3_multi_direct_5</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_br_multi_direct_6</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_cate_multi_direct_7</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_product_ingestionTime_multi_direct_8</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">age</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_user_age_multi_direct_9</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_user_ingestionTime_multi_direct_10</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">sex</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_user_sex_multi_direct_11</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">user_lv_cd</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_user_user_lv_cd_multi_direct_12</span><span class="w"></span>
<span class="k">from</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="w"></span>
<span class="w">    </span><span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">action</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">action_reqId</span><span class="o">`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">action_reqId</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"></span>
<span class="w">    </span><span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">bo_product</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">bo_product_sku_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"></span>
<span class="w">    </span><span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="o">`</span><span class="n">bo_user</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">`</span><span class="n">bo_user_user_id</span><span class="o">`</span><span class="p">.</span><span class="o">`</span><span class="n">user_id</span><span class="o">`</span><span class="p">)</span><span class="w"></span>
<span class="k">as</span><span class="w"> </span><span class="n">out1</span><span class="w"></span>
<span class="k">on</span><span class="w"> </span><span class="n">out0</span><span class="p">.</span><span class="n">reqId_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out1</span><span class="p">.</span><span class="n">reqId_3</span><span class="w"></span>
<span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="k">select</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId_14</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">max</span><span class="p">(</span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_bad_comment_rate_multi_max_13</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">min</span><span class="p">(</span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_bad_comment_rate_multi_min_14</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="k">min</span><span class="p">(</span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_bad_comment_rate_multi_min_15</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_comment_num_multi_unique_count_22</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_has_bad_comment_multi_unique_count_23</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_has_bad_comment_multi_top3frequency_30</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_comment_comment_num_multi_top3frequency_33</span><span class="w"></span>
<span class="k">from</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">dt</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nb">float</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">window</span><span class="w"> </span><span class="n">bo_comment_sku_id_ingestionTime_0s_64d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">dt</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_comment</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">64</span><span class="n">d</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">bo_comment_sku_id_ingestionTime_0_10_</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">dt</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">comment_num</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">has_bad_comment</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">bad_comment_rate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_comment</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">sku_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">))</span><span class="w"></span>
<span class="k">as</span><span class="w"> </span><span class="n">out2</span><span class="w"></span>
<span class="k">on</span><span class="w"> </span><span class="n">out0</span><span class="p">.</span><span class="n">reqId_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out2</span><span class="p">.</span><span class="n">reqId_14</span><span class="w"></span>
<span class="k">last</span><span class="w"> </span><span class="k">join</span><span class="w"></span>
<span class="p">(</span><span class="w"></span>
<span class="k">select</span><span class="w"></span>
<span class="w">    </span><span class="o">`</span><span class="n">reqId</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId_17</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_10h_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_br_multi_top3frequency_16</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_10h_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_cate_multi_top3frequency_17</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_7d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_model_id_multi_top3frequency_18</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_14d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_model_id_multi_unique_count_19</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_7d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_model_id_multi_unique_count_20</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">distinct_count</span><span class="p">(</span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_14d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_type_multi_unique_count_21</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_7d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_type_multi_top3frequency_40</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">fz_topn_frequency</span><span class="p">(</span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="n">over</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_14d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">bo_action_type_multi_top3frequency_42</span><span class="w"></span>
<span class="k">from</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">eventTime</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="nb">bigint</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">flattenRequest</span><span class="o">`</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">window</span><span class="w"> </span><span class="n">bo_action_pair_id_ingestionTime_0s_10h_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_action</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">10</span><span class="n">h</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">bo_action_pair_id_ingestionTime_0s_7d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_action</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">7</span><span class="n">d</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="n">bo_action_pair_id_ingestionTime_0s_14d_100</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<span class="k">UNION</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">time</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">model_id</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="k">type</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">cate</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="o">`</span><span class="n">br</span><span class="o">`</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">reqId</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="o">`</span><span class="n">bo_action</span><span class="o">`</span><span class="p">)</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">pair_id</span><span class="o">`</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="o">`</span><span class="n">ingestionTime</span><span class="o">`</span><span class="w"> </span><span class="n">rows_range</span><span class="w"> </span><span class="k">between</span><span class="w"> </span><span class="mi">14</span><span class="n">d</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="mi">0</span><span class="n">s</span><span class="w"> </span><span class="n">preceding</span><span class="w"> </span><span class="n">MAXSIZE</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="n">INSTANCE_NOT_IN_WINDOW</span><span class="p">))</span><span class="w"></span>
<span class="k">as</span><span class="w"> </span><span class="n">out3</span><span class="w"></span>
<span class="k">on</span><span class="w"> </span><span class="n">out0</span><span class="p">.</span><span class="n">reqId_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">out3</span><span class="p">.</span><span class="n">reqId_17</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openmldb</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">zk_cluster</span><span class="o">=</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">2181</span> <span class="o">--</span><span class="n">zk_root_path</span><span class="o">=/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">role</span><span class="o">=</span><span class="n">sql_client</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">deploy</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
<p>Use the following command to check the deployment details:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">show</span><span class="w"> </span><span class="n">deployment</span><span class="w"> </span><span class="n">demo</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="online-data-import">
<h4>3.2.2 Online Data Import<a class="headerlink" href="#online-data-import" title="Permalink to this headline">#</a></h4>
<p>We need to import the data for real-time feature extraction. First, you need to switch to <strong>online</strong> execution mode. Then, in the online mode, import the sample data as the online data source. The following commands are executed under the OpenMLDB CLI.</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">USE</span><span class="w"> </span><span class="n">JD_db</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="o">@@</span><span class="n">execute_mode</span><span class="o">=</span><span class="s1">&#39;online&#39;</span><span class="p">;</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/action/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/flattenRequest_clean/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">flattenRequest</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/bo_user/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_user</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/bo_action/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_action</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/bo_product/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_product</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">);</span><span class="w"></span>
<span class="o">&gt;</span><span class="w"> </span><span class="k">LOAD</span><span class="w"> </span><span class="k">DATA</span><span class="w"> </span><span class="n">INFILE</span><span class="w"> </span><span class="s1">&#39;/root/project/data/JD_data/bo_comment/*.parquet&#39;</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">bo_comment</span><span class="w"> </span><span class="k">options</span><span class="p">(</span><span class="n">format</span><span class="o">=</span><span class="s1">&#39;parquet&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">true</span><span class="p">,</span><span class="w"> </span><span class="k">mode</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">openmldb</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">zk_cluster</span><span class="o">=</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">2181</span> <span class="o">--</span><span class="n">zk_root_path</span><span class="o">=/</span><span class="n">openmldb</span> <span class="o">--</span><span class="n">role</span><span class="o">=</span><span class="n">sql_client</span> <span class="o">&lt;</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">load_online_data</span><span class="o">.</span><span class="n">sql</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the cluster version <code class="docutils literal notranslate"><span class="pre">LOAD</span>&#160; <span class="pre">DATA</span></code> is a non-blocking task. You can use the command <code class="docutils literal notranslate"><span class="pre">SHOW</span> <span class="pre">JOBS</span></code> to view the running status of the task. Please wait for the task to run successfully (<code class="docutils literal notranslate"><span class="pre">state</span></code> to <code class="docutils literal notranslate"><span class="pre">FINISHED</span></code> status) before proceeding to the next step.</p>
</div>
</section>
</section>
<section id="configure-oneflow-model-serving">
<h3>3.3 Configure OneFlow Model Serving<a class="headerlink" href="#configure-oneflow-model-serving" title="Permalink to this headline">#</a></h3>
<p>OneFlow model serving requires <a class="reference external" href="https://docs.oneflow.org/en/master/cookies/one_embedding.html">OneEmbedding</a>. The support for OneEmbedding is currently not merged into the main project. If re-compilation is required, you can refer to the guide as specified in Appendix A. The following steps assume that the relevant support is compiled and saved to directory <code class="docutils literal notranslate"><span class="pre">/home/gtest/work/oneflow_serving/</span></code>.</p>
<section id="check-model-path-demodir-oneflow-process-model">
<h4>3.3.1 Check Model Path (<code class="docutils literal notranslate"><span class="pre">$demodir/oneflow_process/model</span></code>)<a class="headerlink" href="#check-model-path-demodir-oneflow-process-model" title="Permalink to this headline">#</a></h4>
<p>Check if model files are correctly organized and saved as shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tree  -L 3 model/
model/
└── embedding
    ├── 1
    │   └── model
    └── config.pbtxt
</pre></div>
</div>
</section>
<section id="check-config-pbtxt-configurations">
<h4>3.3.2 Check <code class="docutils literal notranslate"><span class="pre">config.pbtxt</span></code> configurations.<a class="headerlink" href="#check-config-pbtxt-configurations" title="Permalink to this headline">#</a></h4>
</section>
<section id="check-persistent-demodir-oneflow-process-persistent-path">
<h4>3.3.3 Check persistent (<code class="docutils literal notranslate"><span class="pre">$demodir/oneflow_process/persistent</span></code>) path<a class="headerlink" href="#check-persistent-demodir-oneflow-process-persistent-path" title="Permalink to this headline">#</a></h4>
</section>
</section>
<section id="start-serving">
<h3>3.4 Start Serving<a class="headerlink" href="#start-serving" title="Permalink to this headline">#</a></h3>
<section id="start-openmldb-serving">
<h4>3.4.1 Start OpenMLDB Serving<a class="headerlink" href="#start-openmldb-serving" title="Permalink to this headline">#</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that the following commands are executed in demo docker.</p>
</div>
<ol class="arabic simple">
<li><p>If you have not exited the OpenMLDB CLI, use the <code class="docutils literal notranslate"><span class="pre">quit</span></code> command to exit the OpenMLDB CLI.</p></li>
<li><p>Start the prediction service from the command line:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /root/project/serving/openmldb_serving
./start_predict_server.sh <span class="m">0</span>.0.0.0:9080
</pre></div>
</div>
</section>
<section id="start-oneflow-model-serving">
<h4>3.4.2 Start OneFlow Model Serving<a class="headerlink" href="#start-oneflow-model-serving" title="Permalink to this headline">#</a></h4>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note that following commands are executed in the environment as installed in section 1.1.</p>
</div>
<p>Start OneFlow model serving with the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker run --runtime<span class="o">=</span>nvidia --rm --network<span class="o">=</span>host <span class="se">\</span>
  -v <span class="nv">$demodir</span>/oneflow_process/model:/models <span class="se">\</span>
  -v /home/gtest/work/oneflow_serving/serving/build/libtriton_oneflow.so:/backends/oneflow/libtriton_oneflow.so <span class="se">\</span>
  -v /home/gtest/work/oneflow_serving/oneflow/build/liboneflow_cpp/lib/:/mylib <span class="se">\</span>
  -v <span class="nv">$demodir</span>/oneflow_process/persistent:/root/demo/persistent <span class="se">\</span>
  registry.cn-beijing.aliyuncs.com/oneflow/triton-devel <span class="se">\</span>
  bash -c <span class="s1">&#39;LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/mylib /opt/tritonserver/bin/tritonserver \</span>
<span class="s1">  --model-repository=/models --backend-directory=/backends&#39;</span>
</pre></div>
</div>
</section>
</section>
<section id="send-real-time-request">
<h3>3.5 Send Real-Time Request<a class="headerlink" href="#send-real-time-request" title="Permalink to this headline">#</a></h3>
<p>Requests can be executed outside the OpenMLDB docker. The details can be found in <a class="reference external" href="https://openmldb.ai/docs/en/main/reference/ip_tips.html">IP Configuration</a>.</p>
<p>Execute <code class="docutils literal notranslate"><span class="pre">predict.py</span></code> in command window. This script will send a line of request data to the prediction service. Results will be received and printed out.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python <span class="nv">$demodir</span>/serving/predict.py
</pre></div>
</div>
<p>Sample output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">----------------</span><span class="n">ins</span><span class="o">---------------</span>
<span class="p">[</span><span class="s1">&#39;200001_80005_2016-03-31 18:11:20&#39;</span> <span class="mi">1459419080000</span>
 <span class="s1">&#39;200001_80005_2016-03-31 18:11:20&#39;</span> <span class="s1">&#39;200001_80005&#39;</span> <span class="s1">&#39;80005&#39;</span> <span class="s1">&#39;200001&#39;</span> <span class="mi">1</span> <span class="mf">1.0</span>
 <span class="mf">1.0</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">5</span> <span class="mi">1</span> <span class="s1">&#39;200001_80005_2016-03-31 18:11:20&#39;</span> <span class="kc">None</span> <span class="kc">None</span> <span class="kc">None</span> <span class="kc">None</span> <span class="kc">None</span>
 <span class="kc">None</span> <span class="kc">None</span> <span class="kc">None</span> <span class="kc">None</span> <span class="kc">None</span> <span class="kc">None</span> <span class="s1">&#39;200001_80005_2016-03-31 18:11:20&#39;</span>
 <span class="mf">0.019200000911951065</span> <span class="mf">0.0</span> <span class="mf">0.0</span> <span class="mi">2</span> <span class="mi">2</span> <span class="s1">&#39;1,,NULL&#39;</span> <span class="s1">&#39;4,0,NULL&#39;</span>
 <span class="s1">&#39;200001_80005_2016-03-31 18:11:20&#39;</span> <span class="s1">&#39;,NULL,NULL&#39;</span> <span class="s1">&#39;,NULL,NULL&#39;</span> <span class="s1">&#39;,NULL,NULL&#39;</span>
 <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="s1">&#39;,NULL,NULL&#39;</span> <span class="s1">&#39;,NULL,NULL&#39;</span><span class="p">]</span>
<span class="o">---------------</span><span class="n">predict</span> <span class="n">change</span> <span class="n">of</span> <span class="n">purchase</span> <span class="o">-------------</span>
<span class="p">[[</span><span class="sa">b</span><span class="s1">&#39;0.006222:0&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</section>
</section>
<section id="appendix-a-oneflow-compilation">
<h2>Appendix A – OneFlow Compilation<a class="headerlink" href="#appendix-a-oneflow-compilation" title="Permalink to this headline">#</a></h2>
<p>In this section, we introduce the steps for compilation in order to support OneEmbedding for model serving. This support will be merged into the main branch soon, after which the following steps can be skipped.</p>
<section id="a-1-docker-image">
<h3>A.1 Docker image<a class="headerlink" href="#a-1-docker-image" title="Permalink to this headline">#</a></h3>
<p>The following docker has been pre-installed with all the dependencies required for the compilation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">pull</span> <span class="n">registry</span><span class="o">.</span><span class="n">cn</span><span class="o">-</span><span class="n">beijing</span><span class="o">.</span><span class="n">aliyuncs</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">oneflow</span><span class="o">/</span><span class="n">triton</span><span class="o">-</span><span class="n">devel</span><span class="p">:</span><span class="n">latest</span>
</pre></div>
</div>
<p>Start the docker container and map the relevant directories (Here we map <code class="docutils literal notranslate"><span class="pre">/home/work/gtest</span></code> to <code class="docutils literal notranslate"><span class="pre">/root/project</span></code>). The following steps are performed within the docker container.</p>
</section>
<section id="a-2-oneflow-compilation">
<h3>A.2 OneFlow Compilation<a class="headerlink" href="#a-2-oneflow-compilation" title="Permalink to this headline">#</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> /root/project
mkdir oneflow_serving <span class="o">&amp;&amp;</span> <span class="nb">cd</span> oneflow_serving
git clone -b support_oneembedding_serving --single-branch https://github.com/Oneflow-Inc/oneflow --depth<span class="o">=</span><span class="m">1</span> 
<span class="nb">cd</span> oneflow
mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd</span> build
cmake -C ../cmake/caches/cn/cuda.cmake <span class="se">\</span>
-DBUILD_CPP_API<span class="o">=</span>ON <span class="se">\</span>
-DWITH_MLIR<span class="o">=</span>ON <span class="se">\</span>
-G Ninja <span class="se">\</span>
-DBUILD_SHARED_LIBS<span class="o">=</span>ON <span class="se">\</span>
-DBUILD_HWLOC<span class="o">=</span>OFF <span class="se">\</span>
-DCMAKE_INTERPROCEDURAL_OPTIMIZATION<span class="o">=</span>OFF <span class="se">\</span>
-DCMAKE_EXE_LINKER_FLAGS_INIT<span class="o">=</span><span class="s2">&quot;-fuse-ld=lld&quot;</span> <span class="se">\</span>
-DCMAKE_MODULE_LINKER_FLAGS_INIT<span class="o">=</span><span class="s2">&quot;-fuse-ld=lld&quot;</span> <span class="se">\</span>
-DCMAKE_SHARED_LINKER_FLAGS_INIT<span class="o">=</span><span class="s2">&quot;-fuse-ld=lld&quot;</span> ..
ninja
</pre></div>
</div>
</section>
<section id="a-3-serving-compilation">
<h3>A.3 Serving Compilation<a class="headerlink" href="#a-3-serving-compilation" title="Permalink to this headline">#</a></h3>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>git clone -b support_one_embedding --single-branchhttps://github.com/Oneflow-Inc/serving.git
<span class="nb">cd</span> serving
mkdir build <span class="o">&amp;&amp;</span> <span class="nb">cd</span> build
cmake -DCMAKE_PREFIX_PATH<span class="o">=</span>/path/to/liboneflow_cpp/share -DTRITON_RELATED_REPO_TAG<span class="o">=</span>r21.10 <span class="se">\</span>
  -DTRITON_ENABLE_GPU<span class="o">=</span>ON -G Ninja -DTHIRD_PARTY_MIRROR<span class="o">=</span>aliyun ..
ninja
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">/path/to/liboneflow_cpp/share</span></code> needs to be replaced by the oneflow build directory，which is <code class="docutils literal notranslate"><span class="pre">${oneflow</span> <span class="pre">directory}/build/liboneflow_cpp/share</span></code>.</p>
</section>
<section id="a-4-test-tritonserver">
<h3>A.4 Test TritonServer<a class="headerlink" href="#a-4-test-tritonserver" title="Permalink to this headline">#</a></h3>
<p>Copy backend library files to the designated directory:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>mkdir /root/project/oneflow_sering/backends <span class="o">&amp;&amp;</span> <span class="nb">cd</span> /root/project/oneflow_sering/backends
mkdir oneflow
cp /roor/prject/oneflow_serving/serving/build/libtriton_oneflow.so oneflow/.
</pre></div>
</div>
<p>Start TritonServer：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$LD_LIBRARY_PATH</span>:/root/project/oneflow_serving/oneflow/build/liboneflow_cpp/lib <span class="se">\</span>
/opt/tritonserver/bin/tritonserver <span class="se">\</span>
--model-repository<span class="o">=</span>/root/project/oneflow_process/model <span class="se">\</span>
--backend-directory<span class="o">=</span>/root/project/oneflow_serving/backends
</pre></div>
</div>
<p>Execute the following commands in another command window. If sucessful, sample output will look like as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>python $demodir/serving/client.py 
&gt;&gt;&gt;
0.045439958572387695
(1, 1)
[[b&#39;0.025343:0&#39;]]
</pre></div>
</div>
<p>Note：</p>
<ul class="simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">libunwind.so.8</span></code> cannot be found, you need to map the path for <code class="docutils literal notranslate"><span class="pre">libunwind.so.8</span></code> with <code class="docutils literal notranslate"><span class="pre">-v</span> <span class="pre">/lib/x86_64-linux-gnu:/unwind_path</span></code>, and then add to <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> by <code class="docutils literal notranslate"><span class="pre">...</span> <span class="pre">bash</span> <span class="pre">-c</span> <span class="pre">'LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/mylib:/unwind_path</span> <span class="pre">...</span></code></p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">libcupti.so</span></code>cannot be found, you need to map the path for <code class="docutils literal notranslate"><span class="pre">libcupti.so</span></code> with
<code class="docutils literal notranslate"><span class="pre">-v</span> <span class="pre">/usr/local/cuda-11.7/extras/CUPTI/lib64:/cupti_path</span></code>, and then add to <code class="docutils literal notranslate"><span class="pre">LD_LIBRARY_PATH</span></code> by <code class="docutils literal notranslate"><span class="pre">...</span> <span class="pre">bash</span> <span class="pre">-c</span> <span class="pre">'LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/mylib:/cupti_path</span> <span class="pre">...</span></code>. To find the actual cuda directory, you can use <code class="docutils literal notranslate"><span class="pre">ldd</span> <span class="pre">${oneflow</span> <span class="pre">directory}/build/liboneflow.so</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">cupti</span></code></p></li>
</ul>
</section>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="dolphinscheduler_task_demo.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Building End-to-End MLOps Workflows (OpenMLDB + DolphinScheduler)</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../deploy/index.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Deployment</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By OpenMLDB<br/>
  
      &copy; Copyright 2022, OpenMLDB.<br/>
    Last updated on Aug 27, 2022, 3:54:29 PM.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>